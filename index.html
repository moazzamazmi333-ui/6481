<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BookGadi | Tracker PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { --primary: #2563eb; --danger: #ef4444; --dark: #1e293b; }
  html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background: #fff; display: flex; flex-direction: column; overflow: hidden; }
  #mainCard { width: 100%; background: #fff; padding: 12px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 20; border-bottom: 1px solid #eee; }
  .container { width: 92%; margin: 0 auto; }
  .top-row { display: flex; gap: 12px; align-items: center; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 10px; }
  #driverPhoto { width: 55px; height: 55px; border-radius: 12px; object-fit: cover; border: 2px solid #eee; }
  .driver-meta { flex: 1; }
  #driverName { font-weight: 800; font-size: 15px; color: var(--dark); display: block; }
  #driverCar { font-size: 12px; color: #64748b; font-weight: 600; }
  #driverMobile { font-size: 12px; color: var(--primary); text-decoration: none; font-weight: 700; display: block; margin-top: 2px; }
  .stats-row { display: flex; justify-content: space-between; text-align: center; }
  .stat-item { flex: 1; }
  .stat-item small { font-size: 9px; color: #64748b; text-transform: uppercase; font-weight: 700; }
  .stat-item b { display: block; font-size: 13px; color: var(--dark); margin-top: 2px; }
  #driverAddress { background: #f8fafc; color: var(--danger); font-size: 10px; font-weight: 700; padding: 6px; border-radius: 6px; margin-top: 8px; border: 1px solid #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  #map-wrapper { flex: 1; width: 100%; position: relative; }
  #map { width: 100%; height: 100%; }
  .map-controls { position: absolute; left: 10px; bottom: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 100; }
  .map-controls button { width: 45px; height: 45px; border-radius: 12px; border: none; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
  #btnVehicle { background: var(--primary); color: white; }
</style>
</head>
<body>

<div id="mainCard">
  <div class="container">
    <div class="top-row">
      <img id="driverPhoto" src="" alt="Driver">
      <div class="driver-meta">
        <span id="driverName">Connecting...</span>
        <span id="driverCar">Vehicle: --</span>
        <a id="driverMobile" href="#">üìû Call Driver</a>
      </div>
      <div style="text-align: right;">
        <small style="font-size: 9px; font-weight: 700;">SPEED</small>
        <b id="speed" style="display: block; font-size: 16px; color: var(--primary);">0</b>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-item"><small>Distance</small><b id="dist">--</b></div>
      <div class="stat-item" style="border-left: 1px solid #eee; border-right: 1px solid #eee;"><small>ETA</small><b id="eta">--</b></div>
      <div class="stat-item"><small>Status</small><b id="ignition">OFF</b></div>
    </div>

    <div id="driverAddress">üìç Checking GPS Signal...</div>
  </div>
</div>

<div id="map-wrapper">
  <div id="map"></div>
  <div class="map-controls">
    <button id="btnTraffic">üö¶</button>
    <button id="btnMe">üìç</button>
    <button id="btnVehicle">üöó</button>
  </div>
</div>

<script>
const API_KEY = "AIzaSyB8fFUPeGfUy8Wwh-mQ_d3fbGZzKBy7VwM";
const GPS_API = "https://gps51-proxy.moazzamazmi333.workers.dev/";
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTltU6LSbArrr2O_xNGwpGPVlGyjo7i3bL4cN0KgdGGkJijj1l0z1NR6P2mhn02rWDeyqdQha4OoEQc/pub?gid=587843648&single=true&output=csv";
const CAR_ICON_URL = "https://static.wixstatic.com/media/843689_497878e241e348adbd167a8cc7462f1b~mv2.png";

let map, userMarker, directionsService, directionsRenderer, geocoder, trafficLayer;
let clat, clng, ulat, ulng, DEVICE_ID, followVehicle = true;

let carOverlay = null;

function setStatus(msg){ document.getElementById("driverAddress").innerText="üìç "+msg; }

/* ‚úÖ Auto User Location (GitHub) */
function getUserLocation(){
  if(!navigator.geolocation){
    setStatus("Geolocation not supported");
    return;
  }

  navigator.geolocation.watchPosition(
    (pos)=>{
      ulat = pos.coords.latitude;
      ulng = pos.coords.longitude;

      const userPos = {lat: ulat, lng: ulng};
      if(!userMarker){
        userMarker = new google.maps.Marker({
          map, position: userPos,
          icon: {path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: "#2563eb", strokeColor: "white", strokeWeight: 2}
        });
      }else userMarker.setPosition(userPos);

      calculateRoute(); // refresh ETA+Distance
    },
    (err)=>{
      setStatus("Allow Location to show ETA");
      document.getElementById("eta").innerText = "Allow Location";
      document.getElementById("dist").innerText = "--";
    },
    { enableHighAccuracy:true, maximumAge:0, timeout:20000 }
  );
}

async function start(){
  const s=document.createElement("script");
  s.src=`https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=geometry`;
  s.async=true; s.defer=true;
  s.onload=initMap;
  document.head.appendChild(s);
}

function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{
    center:{lat:26.85,lng:80.95},
    zoom:15,
    disableDefaultUI:true
  });

  geocoder=new google.maps.Geocoder();

  directionsService=new google.maps.DirectionsService();
  directionsRenderer=new google.maps.DirectionsRenderer({
    map,
    suppressMarkers:true,
    preserveViewport:true,
    polylineOptions:{ strokeColor:"#2563eb", strokeWeight:6 }
  });

  trafficLayer = new google.maps.TrafficLayer();

  const CarOverlay=createCarOverlay();
  carOverlay=new CarOverlay(new google.maps.LatLng(26.85,80.95));
  carOverlay.setMap(map);

  getUserLocation();
  loadSheet();
}

/* ‚úÖ Car overlay */
function createCarOverlay(){
  function CarOverlay(pos){ this.animPos=pos; }
  CarOverlay.prototype=new google.maps.OverlayView();

  CarOverlay.prototype.onAdd=function(){
    this.div=document.createElement("div");
    this.div.style.position="absolute";
    this.div.innerHTML=`<img id="carImg" src="${CAR_ICON_URL}" style="width:60px;height:60px;transition:0.6s;transform-origin:50% 50%;">`;
    this.getPanes().overlayLayer.appendChild(this.div);
  };

  CarOverlay.prototype.draw=function(){
    const proj=this.getProjection();
    const point=proj.fromLatLngToDivPixel(this.animPos);
    if(!point) return;
    this.div.style.left=(point.x-30)+"px";
    this.div.style.top =(point.y-30)+"px";
  };

  CarOverlay.prototype.update=function(pos, head){
    this.animPos=pos;
    const img=document.getElementById("carImg");
    if(img) img.style.transform=`rotate(${head}deg)`;
    this.draw();
  };

  return CarOverlay;
}

async function loadVehicle(){
  if(!DEVICE_ID) return;

  try{
    const r=await fetch(GPS_API + "?t=" + Date.now(), {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ deviceids:[DEVICE_ID] })
    });

    if(!r.ok){
      setStatus("GPS fetch error");
      return;
    }

    const j=await r.json();
    const v=j.records?.[0];
    if(!v) return;

    clat=parseFloat(v.callat);
    clng=parseFloat(v.callon);

    const speed=Math.floor((Number(v.speed)||0)/1000);
    const head=Number(v.course)||0;

    const carPos=new google.maps.LatLng(clat, clng);

    if(carOverlay) carOverlay.update(carPos, head);
    if(followVehicle) map.panTo(carPos);

    document.getElementById("speed").innerText=speed+" km/h";
    document.getElementById("ignition").innerText=speed>0 ? "MOVING" : "IDLE";

    geocoder.geocode({location:carPos}, (res,stat)=>{
      if(stat==="OK" && res[0]) setStatus(res[0].formatted_address);
    });

    calculateRoute(); // refresh ETA+Distance

  }catch(e){
    setStatus("GPS server issue");
  }
}

function calculateRoute(){
  if(!ulat || !ulng){
    document.getElementById("eta").innerText="Allow Location";
    document.getElementById("dist").innerText="--";
    return;
  }
  if(!clat || !clng) return;

  directionsService.route({
    origin:{ lat: ulat, lng: ulng },
    destination:{ lat: clat, lng: clng },
    travelMode: google.maps.TravelMode.DRIVING,
    provideRouteAlternatives:false
  }, (res, stat)=>{
    if(stat==="OK"){
      directionsRenderer.setDirections(res);
      const leg=res.routes[0].legs[0];
      document.getElementById("dist").innerText=leg.distance.text;
      document.getElementById("eta").innerText=leg.duration.text;
    }else{
      document.getElementById("eta").innerText="--";
      document.getElementById("dist").innerText="--";
    }
  });
}

function loadSheet(){
  fetch(SHEET_CSV + "&t=" + Date.now()).then(r=>r.text()).then(csv=>{
    const lines = csv.trim().split("\n");
    if(lines.length<2) return;

    const d=lines[1].split(",");
    DEVICE_ID=d[0].trim();

    document.getElementById("driverName").innerText=d[1]||"Driver";
    document.getElementById("driverCar").innerText="Vehicle: "+(d[3]||"--");
    document.getElementById("driverMobile").href="tel:"+(d[2]||"");
    document.getElementById("driverPhoto").src=d[4]||"";

    loadVehicle();                 // ‚úÖ run once
    setInterval(loadVehicle, 3000);
  });
}

/* buttons */
document.getElementById("btnTraffic").onclick=()=>trafficLayer.setMap(trafficLayer.getMap()?null:map);
document.getElementById("btnMe").onclick=()=>{ followVehicle=false; if(ulat) map.panTo({lat:ulat, lng:ulng}); };
document.getElementById("btnVehicle").onclick=()=>{ followVehicle=true; if(clat) map.panTo({lat:clat, lng:clng}); };

start();
</script>
</body>
</html>
